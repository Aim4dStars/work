<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="cash-h2-tables" author="m034259" dbms="h2">
        <comment>H2: Setup structure</comment>
        <sqlFile path="persistence/schema/h2/acl.sql"/>
        <sqlFile path="persistence/schema/h2/bpay_biller.sql"/>
        <sqlFile path="persistence/schema/h2/bsb.sql"/>
        <sqlFile path="persistence/schema/h2/payee.sql"/>
        <sqlFile path="persistence/schema/h2/users.sql"/>
    </changeSet>

    <changeSet id="cash-h2-acl" author="m034259" dbms="h2" runOnChange="true">
        <comment>H2: Authorisation data</comment>
        <sqlFile path="persistence/data/h2/acl.sql"/>
    </changeSet>

    <changeSet id="cash-h2-test-data" author="m034259" dbms="h2" runOnChange="true" context="test-data">
        <comment>H2: Used to boot strap with test data</comment>
        <sqlFile path="persistence/data/h2/bpay_biller.sql"/>
        <sqlFile path="persistence/data/h2/bsb.sql"/>
        <sqlFile path="persistence/data/h2/payee.sql"/>
    </changeSet>

    <!--
    IMPORTANT NOTE: The change set 'fix-cash-oracle-tables' is added to fix an issue in the change set 'cash-oracle-tables'.
    'cash-oracle-tables' change set will not run properly if 'Users' table is not found, as the schema scripts under
    the change set cannot be executed by liquibase due to format issues in the scripts.

    As neither the change set 'cash-oracle-tables' nor the schema scripts referred in the change set can be modified,
    a new change set and a copy of the schema scripts with the formatting issues fixed have been added.

    This change set will not be run in environments where 'cash-oracle-tables' change set has already been executed. In
     other environments, this change set will be run and 'cash-oracle-tables' change set will be marked as RAN as the
     pre condition is met.
    -->

    <changeSet id="fix-cash-oracle-tables" author="l070813" dbms="oracle">
        <preConditions onError="MARK_RAN" onFail="MARK_RAN">
            <not>
                <changeSetExecuted id="cash-oracle-tables" author="m034259"
                                   changeLogFile="persistence/db.changelog-cash.xml"/>
            </not>
        </preConditions>
        <comment>Oracle: Setup structure</comment>
        <sqlFile endDelimiter="/" splitStatements="true" stripComments="true"
                 path="persistence/schema/oracle/b_payee.tbl"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_users.tbl"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_class.tbl"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_class.seq"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_entry.tbl"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_entry.seq"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_object_identity.tbl"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_object_identity.seq"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_sid.seq"/>
        <sqlFile endDelimiter="/" splitStatements="true" path="persistence/schema/oracle/b_acl_sid.tbl"/>
    </changeSet>

    <!-- This change set was never run. It would have been marked as ran because USERS table was existing in all the
    environments it was run so far.

    It will never be run in the future as the above change set will be creating USERS table.

    Do not make any change to this change set. Ignore it. -->
    <changeSet id="cash-oracle-tables" author="m034259" dbms="oracle">
        <preConditions onError="MARK_RAN" onFail="MARK_RAN">
            <not>
                <tableExists tableName="USERS"/>
            </not>
        </preConditions>
        <comment>Oracle: Setup structure</comment>
        <sqlFile path="persistence/schema/oracle/payee.tbl"/>
        <sqlFile path="persistence/schema/oracle/users.tbl"/>
        <sqlFile path="persistence/schema/oracle/acl_class.tbl"/>
        <sqlFile path="persistence/schema/oracle/acl_class.seq"/>
        <sqlFile path="persistence/schema/oracle/acl_entry.tbl"/>
        <sqlFile path="persistence/schema/oracle/acl_entry.seq"/>
        <sqlFile path="persistence/schema/oracle/acl_object_identity.tbl"/>
        <sqlFile path="persistence/schema/oracle/acl_object_identity.seq"/>
        <sqlFile path="persistence/schema/oracle/acl_sid.seq"/>
        <sqlFile path="persistence/schema/oracle/acl_sid.tbl"/>
    </changeSet>

    <changeSet id="cash-oracle-acl" author="m034259" dbms="oracle" runOnChange="true">
        <comment>Oracle: Authorisation data</comment>
        <sqlFile path="persistence/data/oracle/acl.data"/>
    </changeSet>

    <!-- The below change set will run only in test environment. Note the context given as 'test-data'.

     BPAY_BILLER and BPAY are views that refer to batch tables in PROD environment. In test environments we stub them by
     creating those tables locally and views on top of them. -->

    <changeSet id="cash-oracle-test-schema" author="m034259" dbms="oracle" runOnChange="true" context="test-data">
        <preConditions onError="MARK_RAN" onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from users</sqlCheck>
        </preConditions>
        <comment>Oracle: Create batch tables in the local db and create views for them.</comment>
        <sqlFile path="persistence/schema/oracle/bpay_biller_mst_000001.tbl"/>
        <sqlFile path="persistence/schema/oracle/bsb_mst_000001.tbl"/>
    </changeSet>

    <!-- The below change set will run only in test environment. Note the context given as 'test-data'.

    BPAY_BILLER_MST_000001 and  BSB_MST_000001 tables are stub tables. The scripts given in the below change set
     will populate them with stub data. -->

    <changeSet id="cash-oracle-test-data" author="m034259" dbms="oracle" runOnChange="true" context="test-data">
        <preConditions onError="MARK_RAN" onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from users</sqlCheck>
        </preConditions>
        <comment>Oracle: Used to boot strap with test data</comment>
        <sqlFile path="persistence/data/oracle/bpay_biller.data"/>
        <sqlFile path="persistence/data/oracle/bsb_batch.data"/>
    </changeSet>

</databaseChangeLog>